<Window x:Class="CANMonitor.Views.AutomationView"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:CANMonitor.Views"
        xmlns:vm="clr-namespace:CANMonitor.ViewModels"
        xmlns:models="clr-namespace:CANMonitor.Models.CommonModels"
        Title="无代码自动化测试" 
        Height="800" 
        Width="1200"
        Loaded="Window_Loaded">
    <Window.DataContext>
        <vm:AutomationViewModel/>
    </Window.DataContext>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- 工具栏 -->
        <ToolBar Grid.Row="0" Height="40">
            <ToolBar.Template>
                <ControlTemplate TargetType="ToolBar">
                    <Border Background="#F0F0F0" BorderBrush="#E0E0E0" BorderThickness="0,0,0,1">
                        <StackPanel Orientation="Horizontal" Margin="5">
                            <ContentPresenter/>
                        </StackPanel>
                    </Border>
                </ControlTemplate>
            </ToolBar.Template>
            
            <!-- 模板相关按钮 -->
            <Label Content="模板:" Margin="0,0,5,0"/>
            <ComboBox ItemsSource="{Binding AvailableTemplates}" 
                      SelectedItem="{Binding SelectedTemplate}" 
                      DisplayMemberPath="TemplateName"
                      Width="200" Margin="0,0,10,0" 
                      SelectionChanged="OnTemplateSelectionChanged"/>
            <Button Content="生成脚本" Command="{Binding GenerateScriptCommand}" Margin="0,0,10,0"/>
            
            <!-- 脚本相关按钮 -->
            <Separator Margin="0,0,10,0"/>
            <Button Content="保存脚本" Command="{Binding SaveScriptCommand}" Margin="0,0,5,0"/>
            <Button Content="加载脚本" Command="{Binding LoadScriptCommand}" Margin="0,0,10,0"/>
            
            <!-- 任务相关按钮 -->
            <Separator Margin="0,0,10,0"/>
            <Button Content="创建任务" Command="{Binding CreateTaskCommand}" Margin="0,0,5,0"/>
            <Button Content="运行任务" Command="{Binding RunTaskCommand}" Margin="0,0,10,0"/>
            
            <!-- 测试控制按钮 -->
            <Separator Margin="0,0,10,0"/>
            <Button Content="运行脚本" Command="{Binding RunScriptCommand}" Margin="0,0,5,0"/>
            <Button Content="停止测试" Command="{Binding StopScriptCommand}" Margin="0,0,10,0"/>
            
            <!-- 状态显示 -->
            <Separator Margin="0,0,10,0"/>
            <Label Content="状态:" Margin="0,0,5,0"/>
            <Label Content="{Binding ExecutionStatus}" x:Name="StatusLabel" MinWidth="200"/>
        </ToolBar>

        <!-- 主内容区域 -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="300"/>
            </Grid.ColumnDefinitions>

            <!-- 左侧面板 - 模板参数和任务列表 -->
            <TabControl Grid.Column="0" Margin="5">
                <TabItem Header="模板参数">
                    <StackPanel>
                        <Expander Header="模板信息" IsExpanded="True">
                            <StackPanel Margin="5">
                                <TextBlock Text="模板名称:"/>
                                <TextBlock Text="{Binding SelectedTemplate.TemplateName}" FontWeight="Bold" Margin="0,0,0,10"/>
                                <TextBlock Text="模板描述:"/>
                                <TextBlock Text="{Binding SelectedTemplate.Description}" TextWrapping="Wrap"/>
                            </StackPanel>
                        </Expander>
                        <Expander Header="参数列表">
                            <ItemsControl ItemsSource="{Binding TemplateParameters}" Margin="5">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Margin="0,5,0,5">
                                            <TextBlock Text="{Binding Name}"/>
                                            <TextBox Text="{Binding DefaultValue}" Width="200"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Expander>
                    </StackPanel>
                </TabItem>
                <TabItem Header="任务列表">
                    <StackPanel>
                        <ListBox ItemsSource="{Binding TestTasks}" 
                                 SelectedItem="{Binding CurrentTask}" 
                                 DisplayMemberPath="TaskName" 
                                 Margin="5" Height="200"/>
                        <StackPanel Orientation="Horizontal" Margin="5" HorizontalAlignment="Center">
                            <Button Content="添加脚本" Command="{Binding AddScriptToTaskCommand}" Margin="5"/>
                            <Button Content="移除脚本" Command="{Binding RemoveScriptFromTaskCommand}" Margin="5"/>
                        </StackPanel>
                        <ListBox ItemsSource="{Binding CurrentTaskScriptNames}" Margin="5" Height="150"/>
                    </StackPanel>
                </TabItem>
            </TabControl>

            <!-- 中间面板 - 脚本编辑区域 -->
            <Grid Grid.Column="1" Margin="5">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <!-- 脚本信息 -->
                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                    <Label Content="脚本名称:" Margin="0,0,5,0"/>
                    <TextBox Text="{Binding CurrentScript.ScriptName}" Width="200"/>
                    <Label Content="类型:" Margin="20,0,5,0"/>
                    <ComboBox ItemsSource="{Binding AvailableScriptTypes}" 
                              SelectedItem="{Binding CurrentScript.ScriptType}" Width="100"/>
                    <Label Content="描述:" Margin="20,0,5,0"/>
                    <TextBox Text="{Binding CurrentScript.Description}" Width="250"/>
                </StackPanel>
                
                <!-- 步骤列表 -->
                <ListBox ItemsSource="{Binding CurrentScript.Steps}" 
                         SelectedItem="{Binding SelectedStep}"
                         Grid.Row="1"
                         x:Name="StepsListBox">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Grid Margin="2">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="30"/>
                                    <ColumnDefinition Width="80"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="{Binding Path=ListIndex}" Grid.Column="0"/>
                                <TextBlock Text="{Binding Path=StepType}" Grid.Column="1"/>
                                <TextBlock Text="{Binding Path=StepName}" Grid.Column="2"/>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
                
                <!-- 步骤操作按钮 -->
                <StackPanel Orientation="Horizontal" Grid.Row="2" Margin="0,10,0,0" HorizontalAlignment="Center">
                    <Button Content="添加步骤" Command="{Binding AddStepCommand}" Margin="5"/>
                    <Button Content="编辑步骤" Command="{Binding EditStepCommand}" Margin="5"/>
                    <Button Content="移除步骤" Command="{Binding RemoveStepCommand}" Margin="5"/>
                    <Button Content="上移" Command="{Binding MoveStepUpCommand}" Margin="5"/>
                    <Button Content="下移" Command="{Binding MoveStepDownCommand}" Margin="5"/>
                </StackPanel>
            </Grid>

            <!-- 右侧面板 - 步骤属性和报告 -->
            <TabControl Grid.Column="2" Margin="5">
                <TabItem Header="步骤属性">
                    <StackPanel>
                        <Grid Margin="5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="100"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            
                            <TextBlock Text="步骤名称:" Grid.Row="0" Grid.Column="0"/>
                            <TextBox Text="{Binding SelectedStep.StepName}" Grid.Row="0" Grid.Column="1" Margin="5"/>
                            
                            <TextBlock Text="步骤类型:" Grid.Row="1" Grid.Column="0"/>
                            <ComboBox ItemsSource="{Binding AvailableStepTypes}" 
                                     SelectedItem="{Binding SelectedStep.StepType}" 
                                     Grid.Row="1" Grid.Column="1" Margin="5"/>
                            
                            <TextBlock Text="预期结果:" Grid.Row="2" Grid.Column="0" VerticalAlignment="Top"/>
                            <TextBox Text="{Binding SelectedStep.ExpectedResult}" 
                                     Grid.Row="2" Grid.Column="1" Margin="5" Height="60" TextWrapping="Wrap" AcceptsReturn="True"/>
                        </Grid>
                        
                        <Expander Header="参数设置" Margin="5">
                            <StackPanel x:Name="ParametersPanel">
                                <!-- 参数设置将根据步骤类型动态生成 -->
                                <TextBlock Text="参数设置面板" HorizontalAlignment="Center" Margin="20"/>
                            </StackPanel>
                        </Expander>
                        
                        <Expander Header="前置条件" Margin="5">
                            <StackPanel>
                                <ListBox ItemsSource="{Binding SelectedStep.PreConditions}" Margin="5" Height="100"/>
                                <Button Content="添加条件" Command="{Binding AddPreConditionCommand}" HorizontalAlignment="Center" Margin="5"/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </TabItem>
                
                <TabItem Header="测试报告">
                    <StackPanel>
                        <ListBox ItemsSource="{Binding TestReports}" 
                                 SelectedItem="{Binding CurrentTestReport}" 
                                 Margin="5" Height="150">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel>
                                        <TextBlock Text="{Binding ReportName}" FontWeight="Bold"/>
                                        <TextBlock Text="{Binding GenerateTime}" FontSize="12"/>
                                    </StackPanel>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                        
                        <ContentControl Content="{Binding CurrentTestReport}" Margin="5">
                            <ContentControl.ContentTemplate>
                                <DataTemplate>
                                    <StackPanel>
                                        <TextBlock Text="报告详情:" FontWeight="Bold" Margin="0,10,0,5"/>
                                        <TextBlock Text="结果: {Binding Result}"/>
                                        <TextBlock Text="总步骤: {Binding TotalStepsCount}"/>
                                        <TextBlock Text="通过步骤: {Binding PassedStepsCount}"/>
                                        <TextBlock Text="执行时间: {Binding DurationMs}ms"/>
                                        <TextBlock Text="开始时间: {Binding StartTime}"/>
                                        <TextBlock Text="结束时间: {Binding EndTime}"/>
                                    </StackPanel>
                                </DataTemplate>
                            </ContentControl.ContentTemplate>
                        </ContentControl>
                    </StackPanel>
                </TabItem>
            </TabControl>
        </Grid>

        <!-- 状态栏 -->
        <StatusBar Grid.Row="2" Height="25">
            <TextBlock Text="就绪" x:Name="StatusBarText"/>
        </StatusBar>
    </Grid>
</Window>