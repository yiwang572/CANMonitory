# 报文发送功能UI设计文档

## 1. 概述

本设计文档基于CANBusMonitor设计规范，详细描述BMS总线上位机软件中报文发送模块的用户界面设计，包括菜单栏、视图导航栏、工作区、属性面板和状态栏的布局、组件和交互设计。报文发送模块是BMS监控系统的重要组件，负责创建、编辑和发送CAN报文到总线上。

## 2. 整体布局

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                菜单栏 - 报文发送相关菜单项                         │
├─────────────┬───────────────────────────────────────┬─────────────────────────┤
│             │                                       │                         │
│  导航视图    │             报文发送工作区                │     报文属性面板         │
│             │                                       │                         │
│             │                                       │                         │
└─────────────┴───────────────────────────────────────┴─────────────────────────┘
│                                状态栏 - 发送状态显示                               │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 3. 菜单栏设计

### 3.1 文件菜单（扩展）

```
文件
├── 新建...                     # 创建新的发送配置
├── 打开...                     # 打开已保存的发送配置
├── 保存                        # 保存当前发送配置
├── ──────────
├── 导入发送列表               # 导入已保存的报文列表
├── 导出发送列表               # 导出当前报文列表
├── ──────────
└── 退出
```

- **新建...**: 创建新的报文发送配置，快捷键：Ctrl+N
- **打开...**: 打开已保存的报文发送配置，快捷键：Ctrl+O
- **保存**: 保存当前报文发送配置，快捷键：Ctrl+S
- **导入发送列表**: 导入已保存的报文发送列表
- **导出发送列表**: 导出当前报文发送列表到文件

### 3.2 发送菜单（新增）

```
发送
├── 开始发送                   # 开始发送选中报文
├── 停止发送                   # 停止所有发送
├── ──────────
├── 单条发送                   # 发送选中单条报文
├── 循环发送                   # 启用循环发送模式
├── ──────────
└── 停止所有发送               # 强制停止所有发送
```

- **开始发送**: 开始发送所有选中的报文，快捷键：Ctrl+T
- **停止发送**: 停止所有正在发送的报文，快捷键：Ctrl+P，仅在发送过程中可用
- **单条发送**: 发送选中的单条报文
- **循环发送**: 启用/禁用循环发送模式
- **停止所有发送**: 停止所有当前正在进行的发送任务

### 3.3 工具菜单（新增）

```
工具
├── 报文编辑器                 # 高级报文编辑工具
├── 模板管理器                 # 常用模板管理
├── 脚本编辑器                 # 发送脚本编辑
├── ──────────
├── 校验计算器                 # 校验值计算工具
└── 信号编码器                 # 信号编码工具
```

- **报文编辑器**: 打开高级报文编辑窗口
- **模板管理器**: 管理常用报文模板
- **脚本编辑器**: 打开发送脚本编辑窗口
- **校验计算器**: 打开校验值计算工具
- **信号编码器**: 打开信号编码工具

### 3.4 视图菜单（扩展）

```
视图
├── 报文发送面板               # 显示/隐藏发送面板
├── 发送记录面板               # 显示/隐藏记录面板
├── ──────────
├── 属性面板                   # 显示/隐藏右侧属性面板
└── 状态栏                     # 显示/隐藏底部状态栏
```

- **报文发送面板**: 显示/隐藏报文发送面板
- **发送记录面板**: 显示/隐藏发送记录面板
- **属性面板**: 显示/隐藏右侧属性面板
- **状态栏**: 显示/隐藏底部状态栏

## 4. 视图导航栏设计

### 4.1 报文发送模块导航项

在左侧导航视图中，"报文发送"作为单独的功能模块项，图标采用数据发送相关的图形表示。

```
导航视图
├── 设备连接
├── 报文监控
├── 报文发送                   # 当前模块
│   ├── 基础发送               # 子项
│   ├── 定时发送               # 子项
│   ├── 脚本发送               # 子项
│   └── 模板库                 # 子项
├── DBC管理
├── OBD诊断
├── 自动化测试
└── 系统设置
```

- **图标**：📤 发送图标
- **文字**：报文发送
- **背景色**：选中时使用主色调(#0E4C92)
- **文字色**：白色
- **悬停效果**：背景色加深10%

### 4.2 导航交互

- 点击主项"报文发送"显示默认的基础发送界面
- 点击子项切换到对应的功能视图
- 当前选中的子项以高亮状态显示（使用主题色#0E4C92）
- 支持通过鼠标悬停显示功能提示
- 提供快速访问常用发送配置的功能

## 5. 工作区设计

工作区根据导航栏选择的子项动态切换内容，主要包括以下视图：

### 5.1 基础发送视图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                             报文发送 - 基础发送                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│ 报文配置区域                                                                   │
│ ┌─────────────────────────────────────────────────────────────────────────┐     │
│ │ ID: [0x123    ]  类型: [标准帧 ▼]  格式: [数据帧 ▼]  长度: [8 ▼]        │     │
│ │                                                                         │     │
│ │ 数据:                                                                    │     │
│ │ [00] [11] [22] [33] [44] [55] [66] [77]                                │     │
│ │                                                                         │     │
│ │ 信号映射: [选择信号 ▼] [信号值:    ]                                    │     │
│ └─────────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
│ 发送控制区域                                                                   │
│ ┌─────────────────────────────────────────────────────────────────────────┐     │
│ │ [单次发送]  [开始循环]  [停止发送]                                          │     │
│ │ 循环周期: [1000] ms     □ 循环发送                                          │     │
│ └─────────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
│ 发送历史区域                                                                   │
│ ┌─────────────────────────────────────────────────────────────────────────┐     │
│ │ ID       │ 数据           │ 发送时间       │ 状态        │ [操作]        │     │
│ │─────────────────────────────────────────────────────────────────────────│     │
│ │ 0x123    │ 00 11 22 33... │ 14:30:45.123   │ 成功        │ [重发] [删除] │     │
│ │ 0x456    │ AA BB CC DD... │ 14:30:46.789   │ 成功        │ [重发] [删除] │     │
│ └─────────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

- **报文配置区域**: 设置单条报文的详细参数
  - ID输入：支持标准帧和扩展帧格式
  - 帧类型：标准帧/扩展帧选择
  - 数据格式：数据帧/远程帧选择
  - 数据长度：根据CAN/CAN FD模式动态调整
  - 数据输入：支持HEX和ASCII两种格式
  - DBC信号映射：关联DBC文件中的信号

- **发送控制区域**: 控制报文发送行为
  - 单次发送：立即发送单条报文
  - 循环发送：周期性重复发送
  - 发送周期：设置循环间隔（毫秒）

- **发送历史区域**: 显示最近发送的报文记录
  - 显示发送状态和时间
  - 支持重发和删除操作

### 5.2 定时发送视图

定时发送视图支持设置在特定时间或条件下触发报文发送：

- **定时任务配置**:
  - 任务名称设置
  - 触发条件：一次性、周期性、条件触发
  - 执行时间设置
  - 关联报文选择

- **任务管理**:
  - 任务列表显示
  - 任务状态控制（激活/暂停）
  - 任务编辑和删除

### 5.3 脚本发送视图

脚本发送视图提供高级的程序化控制能力：

- **脚本编辑器**:
  - 支持语法高亮和代码提示
  - 多种脚本语言支持（Lua/Python）
  - 示例脚本库

- **执行控制**:
  - 运行、停止、单步执行
  - 调试模式和变量监控

- **脚本库管理**:
  - 系统函数库和用户自定义脚本
  - 脚本片段拖拽使用

### 5.4 模板库视图

模板库视图管理常用的报文模板：

- **模板分类**:
  - 系统预设模板
  - 用户自定义模板
  - 最近使用模板

- **模板操作**:
  - 模板预览和选择
  - 模板编辑和删除
  - 模板导入和导出

- **快速应用**:
  - 拖拽模板到发送区域
  - 一键应用模板配置
  - 打开模板按钮：文件夹图标
  - 保存模板按钮：磁盘图标
  - 单次发送按钮：单次发送图标
  - 开始定时发送按钮：开始图标
  - 停止定时发送按钮：停止图标
  - 清空列表按钮：垃圾桶图标
  - 导入/导出按钮：导入/导出图标

### 4.2 报文发送列表区域
- **显示方式**：数据网格(DataGrid)
- **列信息**：
  - 复选框：用于选择报文
  - 启用：复选框，控制报文是否启用
  - ID：十六进制显示，可编辑，带输入验证
  - 名称：可编辑，关联DBC名称
  - 类型：下拉选择框（标准帧/扩展帧/CAN FD）
  - 长度：数值输入框，1-8字节(CAN)/1-64字节(CAN FD)
  - 数据：十六进制编辑框，支持字节级编辑
  - 发送类型：下拉选择框（单次/定时/循环/事件触发）
  - 间隔：数值输入框，毫秒
  - 计数：显示已发送次数
  - 操作：按钮组（发送/编辑/删除）

### 4.3 信号编辑区域
- **标题**：信号编辑
- **显示方式**：分组网格
- **功能**：
  - 实时显示DBC解码的信号列表
  - 支持直接编辑信号值，自动编码到报文中
  - 信号值范围验证
  - 单位显示
  - 信号描述提示

### 4.4 发送控制区域
- **标题**：发送控制
- **组件**：
  - 通道选择：下拉选择框，选择发送通道
  - 批量操作：
    - 全选/取消全选按钮
    - 批量启用/禁用按钮
    - 批量设置发送间隔按钮
  - 紧急停止按钮：红色，用于立即停止所有发送

### 4.5 发送记录区域
- **标题**：发送记录
- **显示方式**：可折叠列表视图
- **列信息**：
  - 时间戳：发送时间
  - ID：发送的报文ID
  - 数据：发送的数据内容
  - 状态：发送成功/失败
  - 延迟：发送延迟时间
- **功能**：
  - 自动滚动到底部
  - 支持清空记录
  - 支持导出记录

## 5. 属性面板设计

右侧属性面板在选中报文或信号时显示，设计如下：

### 5.1 报文属性
- **标题**：报文属性
- **属性项**：
  - 报文ID：十六进制和十进制编辑框
  - 报文名称：文本编辑框
  - 帧类型：下拉选择框
  - 数据长度：数值输入框
  - 发送类型：下拉选择框
  - 发送间隔：数值输入框
  - 发送次数限制：数值输入框
  - 优先级：数值输入框
  - 循环冗余校验：复选框和类型选择
  - 备注：多行文本框

### 5.2 信号属性
- **标题**：信号属性
- **显示方式**：可折叠列表
- **每项包含**：
  - 信号名称：显示DBC定义
  - 当前值：可编辑输入框
  - 单位：显示DBC定义
  - 最小值/最大值：显示范围限制
  - 数据类型：显示信号类型
  - 起始位/长度：显示信号位置
  - 因子/偏移量：显示转换系数
  - 描述：显示信号描述

### 5.3 发送选项
- **标题**：高级发送选项
- **属性项**：
  - 通道选择：下拉选择框
  - 发送模式：下拉选择框（正常/高速/低延迟）
  - 重试次数：数值输入框
  - 超时时间：数值输入框
  - 自动增加计数器：复选框
  - 循环发送模式：下拉选择框（连续/停止条件）

### 5.4 模板管理
- **标题**：模板管理
- **功能**：
  - 保存当前配置为模板
  - 加载模板
  - 删除模板
  - 重命名模板
  - 模板列表显示

## 6. 状态栏设计

底部状态栏显示报文发送的关键状态信息，设计如下：

### 6.1 左侧区域
- **发送状态**：
  - 颜色：绿色（发送中）/红色（停止）
  - 文字："发送中" 或 "已停止"
- **设备状态**：
  - 格式："设备: [设备名称] | 通道: [通道号]"
  - 颜色：绿色（正常）/红色（断开）

### 6.2 中间区域
- **发送统计**：
  - 总发送数：数字显示
  - 成功数：数字显示，绿色
  - 失败数：数字显示，红色
  - 速率：报文/秒
- **活跃发送**：
  - 显示当前正在定时发送的报文数量

### 6.3 右侧区域
- **DBC文件状态**：
  - 显示当前加载的DBC文件名
  - 图标：✅/❌（加载成功/失败）
- **内存使用**：
  - 显示发送队列占用内存
- **帮助按钮**：
  - 图标：❓
  - 功能：打开发送帮助文档

## 7. 交互设计

### 7.1 报文创建与编辑
1. 用户点击"新建报文"按钮或使用快捷键Ctrl+N
2. 在报文列表中生成新行
3. 用户编辑报文ID、名称、类型、长度和数据
4. 编辑过程中提供实时验证和错误提示
5. 保存按钮变为可用状态

### 7.2 单次发送流程
1. 用户在报文列表中选择一个或多个报文
2. 点击"单次发送"按钮或使用快捷键Ctrl+T
3. 发送记录区域显示发送记录
4. 状态栏更新发送统计信息
5. 发送成功/失败通过颜色和图标反馈

### 7.3 定时发送流程
1. 用户设置报文的发送类型为"定时"或"循环"
2. 设置发送间隔
3. 勾选"启用"复选框
4. 点击"开始定时发送"按钮或使用快捷键Ctrl+B
5. 状态栏显示"发送中"状态
6. 定时发送的报文计数不断增加
7. 点击"停止定时发送"按钮或使用快捷键Ctrl+E停止发送

### 7.4 信号编辑交互
1. 用户编辑报文中的数据字段
2. 信号列表实时更新显示解码后的信号值
3. 或用户直接编辑信号值
4. 系统自动计算并更新报文中的数据字段
5. 提供信号值超出范围的警告

## 8. 视觉设计规范

### 8.1 配色方案
- **主色调**：深蓝色(#0E4C92)
- **辅助色**：
  - 成功色：绿色(#4ECDC4)
  - 警告色：黄色(#FFD166)
  - 错误色：红色(#FF6B6B)
  - 发送按钮：橙色(#FF8C42)
- **中性色**：
  - 背景色：浅灰(#F8F9FA)
  - 文字色：深灰(#343A40)
  - 边框色：中灰(#CED4DA)
- **特殊编码**：
  - 启用的报文：绿色边框
  - 定时发送中：黄色高亮
  - 错误的报文：红色边框

### 8.2 控件样式
- **数据网格**：斑马纹行，可编辑单元格
- **按钮**：圆角矩形，图标+文字
- **编辑框**：浅灰色背景，聚焦时边框高亮
- **下拉框**：简洁风格，带搜索功能
- **发送记录**：时间戳和状态清晰显示

### 8.3 字体规范
- **标题**：微软雅黑，16px，粗体
- **子标题**：微软雅黑，14px，半粗体
- **正文**：微软雅黑，12px，常规
- **状态栏**：微软雅黑，11px，常规
- **十六进制数据**：等宽字体（Consolas），11px

## 9. 响应式设计

### 9.1 窗口大小调整
- 窗口宽度<1280px时：属性面板自动隐藏，提供按钮可快速显示/隐藏
- 窗口宽度<1024px时：信号编辑区域折叠为可展开面板
- 窗口宽度<800px时：发送记录区域完全隐藏
- 窗口高度<600px时：状态栏自动隐藏，各面板高度自适应

### 9.2 高DPI适配
- 支持100%、125%、150%、200% DPI缩放
- 所有控件和字体使用WPF自动缩放机制
- 编辑框内容保持清晰可读

### 9.3 布局优化
- 支持自定义布局，用户可拖拽调整面板大小和位置
- 支持保存/加载不同的布局配置
- 提供紧凑模式，适合小屏幕使用

## 10. 性能优化

### 10.1 发送队列优化
- 使用高效的发送队列管理机制
- 支持批量发送操作合并
- 大数量报文时自动优化发送调度

### 10.2 数据编辑性能
- 实时验证和编码优化，避免频繁计算
- 大型报文列表时使用虚拟化技术
- 缓存常用操作结果

### 10.3 界面响应性能
- 发送操作在后台线程执行
- UI更新使用批量处理
- 长时间运行的操作提供进度反馈

## 11. 无障碍设计

### 11.1 键盘导航
- 所有功能支持快捷键操作
- 数据网格支持方向键和Tab键导航
- 编辑操作支持键盘输入和快捷键

### 11.2 屏幕阅读器支持
- 所有控件添加Accessibility属性
- 发送状态变化提供朗读提示
- 错误信息提供详细文本描述

### 11.3 颜色对比度
- 文字与背景对比度符合WCAG AA标准
- 使用多种提示方式（颜色+图标+文字）
- 支持高对比度模式

---

**文档版本**: 1.0
**创建日期**: 2024-01-01
**设计作者**: UI设计团队